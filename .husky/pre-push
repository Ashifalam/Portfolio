#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-push quality checks..."

########################################
# ESLint check with error count limit
########################################
echo "ğŸ“‹ Running ESLint..."
ESLINT_OUTPUT=$(npm run lint 2>&1)
MAX_ALLOWED_ERRORS=28

# Try to extract ESLint error count from output
ERROR_COUNT=$(echo "$ESLINT_OUTPUT" | grep "âœ–" | grep -o "[0-9]\+ problems" | grep -o "[0-9]\+")

if [ -z "$ERROR_COUNT" ]; then
  ERROR_COUNT=999
  echo "âš ï¸  Could not parse ESLint error count, defaulting to $ERROR_COUNT"
fi

echo "$ESLINT_OUTPUT"
echo "ğŸ“Š Found $ERROR_COUNT ESLint errors (max allowed: $MAX_ALLOWED_ERRORS)"

if [ "$ERROR_COUNT" -gt "$MAX_ALLOWED_ERRORS" ]; then
  echo "âŒ ESLint error count ($ERROR_COUNT) exceeds max allowed ($MAX_ALLOWED_ERRORS)."
  echo "ğŸ”§ Run 'npm run lint:fix' to fix issues."
  exit 1
else
  echo "âœ… ESLint error count ($ERROR_COUNT) is within limit."
  echo "ğŸ“ Consider fixing remaining errors in future commits."
fi

########################################
# Prettier check
########################################
echo "ğŸ¨ Checking code formatting with Prettier..."
npm run format:check
if [ $? -ne 0 ]; then
  echo "âŒ Prettier found formatting issues. Run 'npm run format' to fix them."
  exit 1
fi

########################################
# Test runner
########################################
echo "ğŸ§ª Running tests..."
npm run test:ci
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Fix failing tests before pushing."
  exit 1
fi

########################################
# Build check
########################################
echo "ğŸ—ï¸ Running build check..."
npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Build failed. Fix build issues before pushing."
  exit 1
fi

echo "âœ… All pre-push checks passed! ğŸš€"
